<html>
<head>
<meta charset="utf-8"></meta><title>yatima-inc/LSpec</title>
<link rel="stylesheet" href="./static/style.css"></link></head>
<body>
<header>
<h1>
<a href="./">Reservoir</a>
</h1>
<input placeholder="Text in here to navigate!"></input><ul>
<li>
<a href="#">About</a>
</li>
<li>
<a href="#">New</a>
</li>
<li>
<a href="#">Trending</a>
</li>
</ul>
</header>
<main>
<h1>yatima-inc/LSpec</h1>
<p>A Testing Framework for Lean</p>
<a href="https://github.com/yatima-inc/LSpec">GitHub Link</a>
<a href="#" title="Missing now!">Documentation</a>
<h2>Pick a version!</h2>
<p>TODO: should show a time axes that allows the users to view, filter and click copy the lakefile config.</p>
<h2>README</h2>
<div class="md" data-path="README.md" id="readme"><article class="markdown-body entry-content container-lg" itemprop="text"><h3 dir="auto">LSpec</h3>
<p dir="auto">A testing framework for Lean 4, inspired by Haskell's <a href="https://hspec.github.io/" rel="nofollow">Hspec</a> package.</p>
<h4 dir="auto">Usage</h4>
<h5 dir="auto">Composing tests</h5>
<p dir="auto">Sequences of tests are represented by the <code>TestSeq</code> datatype.
In order to instantiate terms of <code>TestSeq</code>, use the <code>test</code> helper function:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="#check
  test "Nat equality" (4 = 4) $
  test "Nat inequality" (4 ≠ 5)
-- test "Nat equality" (4 = 4) (test "Nat inequality" (4 ≠ 5)) : TestSeq"><pre><span class="pl-k">#check</span>
  test <span class="pl-s"><span class="pl-pds">"</span>Nat equality<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>) $
  test <span class="pl-s"><span class="pl-pds">"</span>Nat inequality<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> ≠ <span class="pl-c1">5</span>)
<span class="pl-c"><span class="pl-c">--</span> test "Nat equality" (4 = 4) (test "Nat inequality" (4 ≠ 5)) : TestSeq</span></pre></div>
<p dir="auto"><code>test</code> consumes a description a proposition and a next test
The proposition, however, must have its own instance of <code>TDecidable</code>.</p>
<h5 dir="auto">The <code>TDecidable</code> class</h5>
<p dir="auto"><code>TDecidable</code> is how Lean is instructed to decide whether certain propositions are resolved as <code>true</code> or <code>false</code>.</p>
<p dir="auto">This is an example of a simple instance for decidability of equalities:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="instance (x y : α) [DecidableEq α] [Repr α] : TDecidable (x = y) :=
  if h : x = y then
    .isTrue h
  else
    .isFalse h s!"Not equal: {repr x} and {repr y}""><pre><span class="pl-k">instance</span> (x y : α) [DecidableEq α] [Repr α] : TDecidable (x = y) :=
  <span class="pl-k">if</span> h : x = y <span class="pl-k">then</span>
    .isTrue h
  <span class="pl-k">else</span>
    .isFalse h s!<span class="pl-s"><span class="pl-pds">"</span>Not equal: {repr x} and {repr y}<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">The custom failure message is optional.</p>
<p dir="auto">There are more examples of <code>TDecidable</code> instances in <a href="LSpec/Instances.lean">LSpec/Instances.lean</a>.
Such instances are automatically imported via <code>import LSpec</code>.</p>
<p dir="auto">The user is, of course, free to provide their own instances.</p>
<h5 dir="auto">Actually running the tests</h5>
<h6 dir="auto">The <code>#lspec</code> command</h6>
<p dir="auto">The <code>#lspec</code> command allows you to test interactively in a file.</p>
<p dir="auto">Examples:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="#lspec
  test "four equals four" (4 = 4) $
  test "five equals five" (5 = 5)
-- ✓ four equals four
-- ✓ five equals five

#lspec do
  test "four equals four" (4 = 4)
  test "five equals five" (5 = 5)
-- ✓ four equals four
-- ✓ five equals five"><pre>#lspec
  test <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>) $
  test <span class="pl-s"><span class="pl-pds">"</span>five equals five<span class="pl-pds">"</span></span> (<span class="pl-c1">5</span> = <span class="pl-c1">5</span>)
<span class="pl-c"><span class="pl-c">--</span> ✓ four equals four</span>
<span class="pl-c"><span class="pl-c">--</span> ✓ five equals five</span>

#lspec <span class="pl-k">do</span>
  test <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>)
  test <span class="pl-s"><span class="pl-pds">"</span>five equals five<span class="pl-pds">"</span></span> (<span class="pl-c1">5</span> = <span class="pl-c1">5</span>)
<span class="pl-c"><span class="pl-c">--</span> ✓ four equals four</span>
<span class="pl-c"><span class="pl-c">--</span> ✓ five equals five</span></pre></div>
<p dir="auto">An important note is that a failing test will raise an error, interrupting the building process.</p>
<p dir="auto">The fact that test execution happens in the <code>LSpec</code> monad allows the use of <code>do</code> notation, as seen above.
So one can (ab)use the <code>do</code> notation run multiple tests without dollar signs.
In such case, every call to <code>test</code> creates a <code>TestSeq</code> with a single test.</p>
<h6 dir="auto">The <code>lspec</code> function</h6>
<p dir="auto">The <code>lspec</code> function can be used for generic purposes inside other functions.
It returns a term of type <code>Except String String</code>, representing success or failure, with a message for each case.</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="def tests :=
  test "four equals four" (4 = 4) $
  test "five equals five" (5 = 5)

def foo : IO Unit := do
  match lspec tests with
  | .ok    msg => IO.println msg
  | .error msg => IO.eprintln msg"><pre><span class="pl-k">def</span> <span class="pl-en">tests</span> :=
  test <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>) $
  test <span class="pl-s"><span class="pl-pds">"</span>five equals five<span class="pl-pds">"</span></span> (<span class="pl-c1">5</span> = <span class="pl-c1">5</span>)

<span class="pl-k">def</span> <span class="pl-en">foo</span> : IO Unit := <span class="pl-k">do</span>
  <span class="pl-k">match</span> lspec tests <span class="pl-k">with</span>
  | .ok    msg => IO.println msg
  | .error msg => IO.eprintln msg</pre></div>
<h6 dir="auto">The <code>lspecIO</code> function</h6>
<p dir="auto"><code>lspecIO</code> is meant to be used in files to be compiled and integrated in a testing infrastructure, as shown soon.</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="def fourIO : IO Nat :=
  return 4

def fiveIO : IO Nat :=
  return 5

def main : IO UInt32 := do
  let four ← fourIO
  let five ← fiveIO
  lspec do
    test "fourIO equals 4" (four = 4)
    test "fiveIO equals 5" (five = 5)"><pre><span class="pl-k">def</span> <span class="pl-en">fourIO</span> : IO Nat :=
  return <span class="pl-c1">4</span>

<span class="pl-k">def</span> <span class="pl-en">fiveIO</span> : IO Nat :=
  return <span class="pl-c1">5</span>

<span class="pl-k">def</span> <span class="pl-en">main</span> : IO UInt32 := <span class="pl-k">do</span>
  <span class="pl-k">let</span> four ← fourIO
  <span class="pl-k">let</span> five ← fiveIO
  lspec <span class="pl-k">do</span>
    test <span class="pl-s"><span class="pl-pds">"</span>fourIO equals 4<span class="pl-pds">"</span></span> (four = <span class="pl-c1">4</span>)
    test <span class="pl-s"><span class="pl-pds">"</span>fiveIO equals 5<span class="pl-pds">"</span></span> (five = <span class="pl-c1">5</span>)</pre></div>
<h4 dir="auto">Setting up a testing infra</h4>
<p dir="auto">The LSpec package also provides a binary that runs test files automatically.
The binary becomes available by running <code>lake build LSpec</code>, which will generate the file <code>./lean_packages/LSpec/build/bin/lspec</code>.</p>
<p dir="auto">The <code>lspec</code> binary recursively searches for Lean files inside a <code>Tests</code> directory.
For each Lean file present <code>Tests</code>, there must exist a corresponding <code>lean_exe</code> in your <code>lakefile.lean</code>.</p>
<p dir="auto">For instance, suppose that the directory <code>Tests</code> contains the files <code>Tests/F1.lean</code> and <code>Tests/Some/Dir/F2.lean</code>.
In this case, you need to add the following lines to your <code>lakefile.lean</code>:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="lean_exe Tests.F1
lean_exe Tests.Some.Dir.F2"><pre>lean_exe Tests.F1
lean_exe Tests.Some.Dir.F2</pre></div>
<h5 dir="auto">Using LSpec on CI</h5>
<p dir="auto">To integrate LSpec to GitHub workflows, create the file <code>.github/workflows/lspec.yml</code> with the content:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="name: "LSpec CI"
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: install elan
        run: |
          set -o pipefail
          curl -sSfL https://github.com/leanprover/elan/releases/download/v1.3.1/elan-x86_64-unknown-linux-gnu.tar.gz | tar xz
          ./elan-init -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - uses: actions/checkout@v2
      - name: build LSpec
        run: lake build LSpec
      - name: run LSpec
        run: ./lean_packages/LSpec/build/bin/lspec"><pre><span class="pl-ent">name</span>: <span class="pl-s"><span class="pl-pds">"</span>LSpec CI<span class="pl-pds">"</span></span>
<span class="pl-ent">on</span>:
  <span class="pl-ent">pull_request</span>:
  <span class="pl-ent">push</span>:
    <span class="pl-ent">branches</span>:
      - <span class="pl-s">main</span>
<span class="pl-ent">jobs</span>:
  <span class="pl-ent">build</span>:
    <span class="pl-ent">name</span>: <span class="pl-s">Build</span>
    <span class="pl-ent">runs-on</span>: <span class="pl-s">ubuntu-latest</span>
    <span class="pl-ent">steps</span>:
      - <span class="pl-ent">name</span>: <span class="pl-s">install elan</span>
        <span class="pl-ent">run</span>: <span class="pl-s">|</span>
<span class="pl-s">          set -o pipefail</span>
<span class="pl-s">          curl -sSfL https://github.com/leanprover/elan/releases/download/v1.3.1/elan-x86_64-unknown-linux-gnu.tar.gz | tar xz</span>
<span class="pl-s">          ./elan-init -y --default-toolchain none</span>
<span class="pl-s">          echo "$HOME/.elan/bin" >> $GITHUB_PATH</span>
<span class="pl-s"></span>      - <span class="pl-ent">uses</span>: <span class="pl-s">actions/checkout@v2</span>
      - <span class="pl-ent">name</span>: <span class="pl-s">build LSpec</span>
        <span class="pl-ent">run</span>: <span class="pl-s">lake build LSpec</span>
      - <span class="pl-ent">name</span>: <span class="pl-s">run LSpec</span>
        <span class="pl-ent">run</span>: <span class="pl-s">./lean_packages/LSpec/build/bin/lspec</span></pre></div>
</article></div></main>
</body>
</html>