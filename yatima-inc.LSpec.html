<html>
<head>
<meta charset="utf-8"></meta><title>yatima-inc/LSpec</title>
<link rel="stylesheet" href="./static/style.css"></link></head>
<body>
<header>
<h1>
<a href="./">Reservoir</a>
</h1>
<input placeholder="Text in here to navigate!"></input><ul>
<li>
<a href="#">About</a>
</li>
<li>
<a href="#">New</a>
</li>
<li>
<a href="#">Trending</a>
</li>
</ul>
</header>
<main>
<h1>yatima-inc/LSpec</h1>
<p>A Testing Framework for Lean</p>
<a href="https://github.com/yatima-inc/LSpec">GitHub Link</a>
<a href="#" title="Missing now!">Documentation</a>
<h2>Pick a version!</h2>
<p>TODO: should show a time axes that allows the users to view, filter and click copy the lakefile config.</p>
<h2>README</h2>
<div class="md" data-path="README.md" id="readme"><article class="markdown-body entry-content container-lg" itemprop="text"><h3 dir="auto">LSpec</h3>
<p dir="auto">A testing framework for Lean 4, inspired by Haskell's <a href="https://hspec.github.io/" rel="nofollow">Hspec</a> package.</p>
<h4 dir="auto">Usage</h4>
<p dir="auto">There are two ways to use LSpec: via the <code>#lspec</code> command and the <code>lspec</code> function.
Both become available once you <code>import LSpec</code>.</p>
<p dir="auto">Use the former when you want to test a function in the same file it is defined.
If you use <code>LSpec</code> as a dependency, a test failure shall interrupt the execution of the <code>lake build</code> command and throw an error visible in the editor.</p>
<p dir="auto">The latter is for writing tests in a separate test file.
Test files can be run independently with the <code>lspec</code> binary, as shown later.</p>
<h5 dir="auto">The <code>TestSeq</code> type</h5>
<p dir="auto"><code>TestSeq</code> is used to represent sequences of tests.
In order to instantiate terms of <code>TestSeq</code>, use one of the two following helper functions:</p>
<ul dir="auto">
<li><code>test</code>: consumes a description and a proposition;</li>
<li><code>test'</code>: consumes a description, a proposition and an (optional) extra <code>TestSeq</code>.
Use it if you don't want to use <code>do</code> notation.</li>
</ul>
<p dir="auto">The propositions above, however, must have their own instances of <code>TDecidable</code>.</p>
<h5 dir="auto">The <code>TDecidable</code> class</h5>
<p dir="auto"><code>TDecidable</code> is how Lean is instructed to decide whether certain propositions are resolved as <code>true</code> or <code>false</code>.
This is an example of a simple instance for decidability of equalities:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="instance (x y : α) [DecidableEq α] [Repr α] : TDecidable (x = y) :=
  if h : x = y then
    .isTrue h
  else
    .isFalse h s!"Not equal: {repr x} and {repr y}""><pre><span class="pl-k">instance</span> (x y : α) [DecidableEq α] [Repr α] : TDecidable (x = y) :=
  <span class="pl-k">if</span> h : x = y <span class="pl-k">then</span>
    .isTrue h
  <span class="pl-k">else</span>
    .isFalse h s!<span class="pl-s"><span class="pl-pds">"</span>Not equal: {repr x} and {repr y}<span class="pl-pds">"</span></span></pre></div>
<p dir="auto">The custom failure message is optional.</p>
<p dir="auto">There are more examples of <code>TDecidable</code> instances in <a href="LSpec/Instances.lean">LSpec/Instances.lean</a>.
Such instances are automatically imported via <code>import LSpec</code>.</p>
<p dir="auto">The user is, of course, free to provide their own instances.</p>
<h5 dir="auto">The <code>#lspec</code> command</h5>
<p dir="auto">The <code>#lspec</code> command allows you to test interactively in a file.
It requires one argument <code>t : TestSeq</code>.</p>
<p dir="auto">Examples:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="import LSpec

#lspec do
  test "four equals four" (4 = 4)
  test "five equals five" (5 = 5)

#lspec
  test' "four equals four" (4 = 4) $
  test' "five equals five" (5 = 5)"><pre><span class="pl-k">import</span> LSpec

#lspec <span class="pl-k">do</span>
  test <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>)
  test <span class="pl-s"><span class="pl-pds">"</span>five equals five<span class="pl-pds">"</span></span> (<span class="pl-c1">5</span> = <span class="pl-c1">5</span>)

#lspec
  test' <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>) $
  test' <span class="pl-s"><span class="pl-pds">"</span>five equals five<span class="pl-pds">"</span></span> (<span class="pl-c1">5</span> = <span class="pl-c1">5</span>)</pre></div>
<h5 dir="auto">The <code>lspec</code> function</h5>
<p dir="auto">The <code>lspec</code> function is for writing tests in a separate file and represents the result of one <code>LSpec</code> test suite.
Similarly to the <code>#lspec</code> command, it requires an argument of type <code>TestSeq</code>.</p>
<p dir="auto">For example, we can create a standalone <code>Tests.lean</code> file:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="import LSpec

def main := lspec $
  test "four equals four" (4 = 4)"><pre><span class="pl-k">import</span> LSpec

<span class="pl-k">def</span> <span class="pl-en">main</span> := lspec $
  test <span class="pl-s"><span class="pl-pds">"</span>four equals four<span class="pl-pds">"</span></span> (<span class="pl-c1">4</span> = <span class="pl-c1">4</span>)</pre></div>
<p dir="auto">If you run <code>Tests.lean</code>, the expected output should be:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="✓ four equals four"><pre>✓ four equals four</pre></div>
<h6 dir="auto">Running tests with IO</h6>
<p dir="auto">We can use the <code>lspec</code> function to run tests with values that come from
computations in <code>IO</code> like this:</p>
<div class="highlight highlight-source-lean notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="def fourIO : IO Nat :=
  return 4

def fiveIO : IO Nat :=
  return 5

def main : IO UInt32 := do
  let four ← fourIO
  let five ← fiveIO
  lspec do
    test "fourIO equals 4" (four = 4)
    test "fiveIO equals 5" (five = 5)"><pre><span class="pl-k">def</span> <span class="pl-en">fourIO</span> : IO Nat :=
  return <span class="pl-c1">4</span>

<span class="pl-k">def</span> <span class="pl-en">fiveIO</span> : IO Nat :=
  return <span class="pl-c1">5</span>

<span class="pl-k">def</span> <span class="pl-en">main</span> : IO UInt32 := <span class="pl-k">do</span>
  <span class="pl-k">let</span> four ← fourIO
  <span class="pl-k">let</span> five ← fiveIO
  lspec <span class="pl-k">do</span>
    test <span class="pl-s"><span class="pl-pds">"</span>fourIO equals 4<span class="pl-pds">"</span></span> (four = <span class="pl-c1">4</span>)
    test <span class="pl-s"><span class="pl-pds">"</span>fiveIO equals 5<span class="pl-pds">"</span></span> (five = <span class="pl-c1">5</span>)</pre></div>
<h5 dir="auto">The <code>lspec</code> binary</h5>
<p dir="auto">Suppose you want to create multiple test files, each with a separate test suite.
Create a folder called <code>Tests</code> in the root directory of your project and then:</p>
<ol dir="auto">
<li>Add Lean files similar to the <code>Tests.lean</code> example above.</li>
<li>Compile the LSpec binary with <code>lake build LSpec</code>.</li>
<li>Run the binary with <code>./lean_packages/LSpec/build/bin/lspec</code>.</li>
</ol>
<p dir="auto">The <code>lspec</code> binary triggers a <code>lake build</code> automatically, which takes care of interactive tests created with the <code>#lspec</code> command.</p>
<p dir="auto">After building your package, the <code>lspec</code> binary searches for and recursively runs Lean files inside the <code>Tests</code> directory.
It allows adding folders inside <code>Tests</code> to create a custom file structure.</p>
<p dir="auto">For this to work, all of your Lean files used in the tests must be built when <code>lake build</code> is called.</p>
<h4 dir="auto">Using LSpec on CI</h4>
<p dir="auto">To integrate LSpec to GitHub workflows, create the file <code>.github/workflows/lspec.yml</code> with the content:</p>
<div class="highlight highlight-source-yaml notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="name: "LSpec CI"
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: install elan
        run: |
          set -o pipefail
          curl -sSfL https://github.com/leanprover/elan/releases/download/v1.3.1/elan-x86_64-unknown-linux-gnu.tar.gz | tar xz
          ./elan-init -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - uses: actions/checkout@v2
      - name: build LSpec
        run: lake build LSpec
      - name: run LSpec
        run: ./lean_packages/LSpec/build/bin/lspec"><pre><span class="pl-ent">name</span>: <span class="pl-s"><span class="pl-pds">"</span>LSpec CI<span class="pl-pds">"</span></span>
<span class="pl-ent">on</span>:
  <span class="pl-ent">pull_request</span>:
  <span class="pl-ent">push</span>:
    <span class="pl-ent">branches</span>:
      - <span class="pl-s">main</span>
<span class="pl-ent">jobs</span>:
  <span class="pl-ent">build</span>:
    <span class="pl-ent">name</span>: <span class="pl-s">Build</span>
    <span class="pl-ent">runs-on</span>: <span class="pl-s">ubuntu-latest</span>
    <span class="pl-ent">steps</span>:
      - <span class="pl-ent">name</span>: <span class="pl-s">install elan</span>
        <span class="pl-ent">run</span>: <span class="pl-s">|</span>
<span class="pl-s">          set -o pipefail</span>
<span class="pl-s">          curl -sSfL https://github.com/leanprover/elan/releases/download/v1.3.1/elan-x86_64-unknown-linux-gnu.tar.gz | tar xz</span>
<span class="pl-s">          ./elan-init -y --default-toolchain none</span>
<span class="pl-s">          echo "$HOME/.elan/bin" >> $GITHUB_PATH</span>
<span class="pl-s"></span>      - <span class="pl-ent">uses</span>: <span class="pl-s">actions/checkout@v2</span>
      - <span class="pl-ent">name</span>: <span class="pl-s">build LSpec</span>
        <span class="pl-ent">run</span>: <span class="pl-s">lake build LSpec</span>
      - <span class="pl-ent">name</span>: <span class="pl-s">run LSpec</span>
        <span class="pl-ent">run</span>: <span class="pl-s">./lean_packages/LSpec/build/bin/lspec</span></pre></div>
</article></div></main>
</body>
</html>